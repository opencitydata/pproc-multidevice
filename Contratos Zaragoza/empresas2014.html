<?xml version="1.0" encoding="ISO-8859-1" ?>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="es">

<head>
    <title>Contratos Zaragoza</title>


    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

    <style>
        .boton{margin-top:1em;}
    </style>
</head>

<body>

         <img class="pull-right" src="http://www.zaragoza.es/cont/paginas/bs/img/aytoLogoCorto.png" alt="Ayuntamiento de Zaragoza" />
            <h1>Listado de empresas que han trabajado con la administración pública en el año 2014</h1>
			<script src="js/jquery-1.10.2.min.js"></script>
			<p>
			A continuación se muestran los contratos por servicio gestor firmados por el ayuntamiento de Zaragoza.
			</p>
			<p id="tabla"></p>
            <script type="text/javascript">
			var SPARQL_ENDPOINT = 'http://datos.zaragoza.es/sparql';
			var query = 'PREFIX pproc: <http://contsem.unizar.es/def/sector-publico/pproc#>\
			PREFIX s: <http://schema.org/>\
PREFIX dcterms: <http://purl.org/dc/terms/>\
PREFIX pc: <http://purl.org/procurement/public-contracts#>\
PREFIX gr: <http://purl.org/goodrelations/v1#>\
PREFIX dcterms: <http://purl.org/dc/terms/>\
SELECT DISTINCT ?adjudicatario SUM(?importe) as ?totalAdjudicaciones ?CIF ?entidad WHERE {\
SELECT DISTINCT ?contrato  ?adjudicatario ?importe ?CIF ?entidad WHERE {\
?contrato a pproc:Contract;\
a ?type;\
pc:contractingAuthority ?contractingAuthority;\
pc:tender ?tender.\
?contractingAuthority dcterms:title ?entidad.\
?tender pc:supplier ?supplier.\
?supplier <http://www.w3.org/ns/org#identifier> ?CIF. \
?supplier s:name ?adjudicatario.\
?tender pc:offeredPrice ?offeredPriceVAT;\
pproc:formalizedDate ?formalizedDate.\
?offeredPriceVAT gr:hasCurrencyValue ?importe;\
gr:valueAddedTaxIncluded "true"^^xsd:boolean.\
?contrato pproc:contractProcedureSpecifications ?procedureType.\
?procedureType pproc:procedureType ?procedimiento.\
FILTER ( regex(?formalizedDate, "2014")) }}\
ORDER BY (?adjudicatario)'; 
		$.getJSON(SPARQL_ENDPOINT + '?default-graph-uri=&query=' + encodeURIComponent(query) + '&format=application%2Fsparql-results%2Bjson&timeout=0')
    .success(function(data) {
	var feature;
	var table = '<table>';
	table += '<tr><td> <h2>CIF</h2> </td><td> <h2>Adjudicatario</h2> </td><td> <h2>Total Adjudicaciones</h2> </td><td> <h2>Entidad</h2> </td></tr>';
	for (var i = 0; i < data.results.bindings.length; i++) {
				feature = data.results.bindings[i];
                table += '<tr><td>' + feature.CIF.value + '</td><td>' + '<a href="adjudicadosCIF.html?cif='+feature.CIF.value+'">'+feature.adjudicatario.value + '</a>' + '</td><td>' + feature.totalAdjudicaciones.value + '</td><td>' + feature.entidad.value + '</td></tr>';   
                }

	table += '</table>';
	document.getElementById("tabla").innerHTML = table;
	//document.write(table);
        });
		
		/*var url = SPARQL_ENDPOINT
  + '?query=' + encodeURIComponent(query)
  + '&format=' + encodeURIComponent('application/sparql-results+json');
  $.getJSON(url);
  function printTable(response){
    var results = JSON.parse(response);
    var table = '<table>';
    results.results.bindings.forEach(function (result){
        table += '<tr><td>' + result.uri.value + '</td><td>' + result.titulo.value
          + '</td><td>' + result.servicioGestor.value + '</td></tr>';
    })
    table += '</table>';
    document.write(table);
}*/
            </script>
</body>

</html>
