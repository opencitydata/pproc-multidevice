<?xml version="1.0" encoding="ISO-8859-1" ?>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="es">

<head>
    <title>Contratos Zaragoza</title>


    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

    <style>
        .boton{margin-top:1em;}
    </style>
</head>

<body>

         <img class="pull-right" src="http://www.zaragoza.es/cont/paginas/bs/img/aytoLogoCorto.png" alt="Ayuntamiento de Zaragoza" />
            <h1>Contratos mayores de <div id="precio"></div> euros</h1>
			<script src="js/jquery-1.10.2.min.js"></script>
			<p>
			A continuación se muestran los contratos por servicio gestor firmados por el ayuntamiento de Zaragoza.
			</p>
			<p id="tabla"></p>
            <script type="text/javascript">
			var paramstr = window.location.search.substr(1);
			var paramarr = paramstr.split ("&");
			var params = {};

			for ( var i = 0; i < paramarr.length; i++) {
				var tmparr = paramarr[i].split("=");
				params[tmparr[0]] = tmparr[1];
			}
			var fin = params['precio'];
			document.getElementById("precio").innerHTML = fin;
			var SPARQL_ENDPOINT = 'http://datos.zaragoza.es/sparql';
			var query = 'PREFIX pproc: <http://contsem.unizar.es/def/sector-publico/pproc#> \
PREFIX dcterms: <http://purl.org/dc/terms/> \
SELECT DISTINCT ?uri ?empresa ?titulo ?fecha ?Pre/1000000 as ?precio \
WHERE  \
{ \
?uri a <http://contsem.unizar.es/def/sector-publico/pproc#Contract>. \
?uri dcterms:title ?titulo. \
?uri <http://purl.org/procurement/public-contracts#tender> ?a. \
OPTIONAL { ?uri <http://contsem.unizar.es/def/sector-publico/pproc#duration> ?duracion. }\n\
?a   <http://purl.org/procurement/public-contracts#supplier> ?empresaid. \
?empresaid <http://schema.org/name> ?empresa. \
OPTIONAL { ?a <http://contsem.unizar.es/def/sector-publico/pproc#formalizedDate> ?fecha. }\n\
?a <http://purl.org/procurement/public-contracts#offeredPrice> ?po. \
?po <http://purl.org/goodrelations/v1#hasCurrencyValue> ?Pre. \
?po <http://purl.org/goodrelations/v1#valueAddedTaxIncluded> "true"^^xsd:boolean. \
FILTER(xsd:integer(?Pre) > xsd:integer("'+fin+'")) \
} \
ORDER BY DESC(?precio)';
	$.getJSON(SPARQL_ENDPOINT + '?query=' + encodeURIComponent(query) + '&format=application%2Fsparql-results%2Bjson&timeout=0')
   .success(function(data) {
	var feature;
	var table = '<table>';
	table += '<tr> <td><h2>Titulo</h2></td> <td><h2>Empresa</h2></td> <td><h2>Fecha</h2></td> <td><h2>Duracion</h2></td> <td><h2>Precio</h2></td> </tr>';
	for (var i = 0; i < data.results.bindings.length; i++) {
				feature = data.results.bindings[i];
				if ((typeof feature.duracion !== 'undefined')&&(typeof feature.fecha !== 'undefined')){
					table += '<tr><td>' + '<a href='+feature.uri.value+'>'+feature.titulo.value+'</a></td><td>' + feature.empresa.value + '</td> <td>' + feature.fecha.value + '</td> <td>' + feature.duracion.value + '</td> <td>' + feature.precio.value + '</td></tr>';
				}
				else if (typeof feature.duracion !== 'undefined'){
					table += '<tr><td>' + '<a href='+feature.uri.value+'>'+feature.titulo.value+'</a></td><td>' + feature.empresa.value + '</td> <td></td> <td>' + feature.duracion.value + '</td> <td>' + feature.precio.value + '</td></tr>';
				}
				else if (typeof feature.fecha !== 'undefined'){
					table += '<tr><td>' + '<a href='+feature.uri.value+'>'+feature.titulo.value+'</a></td><td>' + feature.empresa.value + '</td> <td>' + feature.fecha.value + '</td> <td></td> <td>' + feature.precio.value + '</td></tr>';
				}
				else
					table += '<tr><td>' + '<a href='+feature.uri.value+'>'+feature.titulo.value+'</a></td><td>' + feature.empresa.value + '</td> <td></td> <td></td> <td>' + feature.precio.value + '</td></tr>';  
				}
	
	table += '</table>';
	document.getElementById("tabla").innerHTML = table;

        });
            </script>
</body>

</html>
